parameters:
  - name: platforms
    type: object
    default:
    - name: 'osx'
      displayName: 'OSX 64 bit'
      folder: "osx-x64"
      archiveType: tar
      archiveFileName: "osx-x64-$(publishTargetFramework).tar.gz"
    - name: 'osxArm'
      displayName: 'OSX ARM 64 bit'
      folder: "osx-arm64"
      archiveType: tar
      archiveFileName: "osx-arm64-$(publishTargetFramework).tar.gz"
    - name: 'linuxArm'
      displayName: 'Linux ARM 64 bit'
      folder: "linux-arm64"
      archiveType: tar
      archiveFileName: "linux-arm64-$(publishTargetFramework).tar.gz"
    - name: 'linux-x64'
      displayName: 'Linux 64 bit'
      folder: "linux-x64"
      archiveType: 'tar'
      archiveFileName: 'linux-x64-$(publishTargetFramework).tar.gz'
    - name: 'windowsx64'
      displayName: 'Windows 64 bit'
      folder: "win-x64"
      archiveType: zip
      archiveFileName: "win-x64-$(publishTargetFramework).zip"
    - name: 'windowsx86'
      displayName: 'Windows 32 bit'
      folder: "win-x86"
      archiveType: zip
      archiveFileName: "win-x86-$(publishTargetFramework).zip"
    - name: 'windowsArm64'
      displayName: 'Windows ARM 64 bit'
      folder: "win-arm64"
      archiveType: zip
      archiveFileName: "win-arm64-$(publishTargetFramework).zip"
  - name: publishProjects
    type: object
    default:
    - 'Microsoft.SqlTools.ServiceLayer'
    - 'Microsoft.SqlTools.Migration'

steps:

- ${{ each project in parameters.projects }}:
  - ${{ each platform in parameters.platforms }}:
    - task: ArchiveFiles@1
      displayName: 'Archive ${{ platform.displayName }} ${{ project }} build'
      inputs:
        rootFolder: '$(Build.SourcesDirectory)/artifacts/publish/${{ project }}/${{ platform.name }}/net8.0'
        includeRootFolder: false
        archiveType: ${{ platform.archiveType }}
        archiveFile: '$(Build.SourcesDirectory)/artifacts/package/${{ project }}-${{ platform.archiveName }}-net8.0.${{ platform.archiveFileFormat }}'
    
- task: PublishBuildArtifacts@1
  displayName: 'Publish Artifact: build archives'
  inputs:
    PathtoPublish: '$(Build.SourcesDirectory)/artifacts/package'

- task: PublishBuildArtifacts@1
  displayName: 'Publish Artifact: nuget packages'
  inputs:
    PathtoPublish: '$(Build.SourcesDirectory)/artifacts/nugetPackages'
    ArtifactName: 'packages'

- task: PublishBuildArtifacts@1
  displayName: 'Publish Artifact: logs'
  inputs:
    PathtoPublish: '$(Build.SourcesDirectory)/artifacts/logs'
    ArtifactName: 'logs'
  condition: true

- task: NuGetCommand@2
  displayName: 'NuGet push'
  condition: eq(variables['PUSH_SYMBOLS'], 'true')
  inputs:
    command: push
    packagesToPush: '$(Build.SourcesDirectory)/artifacts/nugetPackages/**/*.nupkg;!$(Build.ArtifactStagingDirectory)/**/*.symbols.nupkg'
    publishVstsFeed: '2191dd5f-4aec-491b-ac50-568bbc331c8a'
    allowPackageConflicts: true

- task: DotNetCoreCLI@2
  displayName: 'NuGet push SqlCore'
  condition: eq(variables['RELEASE_SQLCORE'], 'true')
  inputs:
    command: push
    packagesToPush: '$(Build.SourcesDirectory)/artifacts/nugetPackages/**/Microsoft.SqlTools.SqlCore.*.nupkg'
    feedPublish: 'mssqltools'
    allowPackageConflicts: true

- task: CodeQL3000Finalize@0
  displayName: 'CodeQL Finalize'
  condition: eq(variables['Codeql.enabled'], 'True')

- task: ms.vss-governance-buildtask.governance-build-task-component-detection.ComponentGovernanceComponentDetection@0
  displayName: 'Component Detection'
  inputs:
    failOnAlert: true